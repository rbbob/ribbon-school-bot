import os
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage

app = Flask(__name__)

# 環境変数から設定を読み込む
line_bot_api = LineBotApi(os.environ['CHANNEL_ACCESS_TOKEN'])
handler = WebhookHandler(os.environ['CHANNEL_SECRET'])

# よくある質問と回答
FAQ = {
    "体験": "体験レッスンは無料で受けられます。所要時間は約１時間で、必要なことをを学べます。",
    "初心者": "もちろん大丈夫です！9割以上の生徒さんが初心者からスタートしています。基礎から丁寧にお教えします。",
    "持ち物": "ノートを鉛筆で大丈夫です。",
    "料金": "単発レッスンは3,500円～、月謝制（月4回）は6,000円~です。",
    "予約": "このLINEでメッセージをいただくか、お電話（06-6651-3832）でご予約ください。",
    "場所": "大阪府大阪市西成区玉出中1-12-23。",
    "時間": "平日10:00-18:00、土曜日午前中です。日曜・祝日はお休みです。"
" MOS 資格取得に必要な費用と時間は？""必要時間"： " ワード：全くの初心者で約30時間 - エクセル：全くの初心者で約30時間 - エキスパート資格も同程度の時間が必要 - **費用**： - 月謝11,000円（月4回）～ "
"全くのパソコン初心者ですがMOS資格を取れるでしょうか？" "はい、取得可能です - リボンスクールでは全くの初心者からMOS資格を取得された方が100名以上います - マウスの使い方がわからないような方にもわかりやすく指導しています"
"パソコンを持っていないのですが大丈夫でしょうか？: - 大丈夫です - パソコン購入のご相談にも応じています - お買い得な購入方法もご案内します" 
"タッチタイピングができないのですがどの位時間と費用がかかるでしょうか？ : **必要時間**：約4～10時間で基本ができるようになります - **費用**：11,000 円(月謝月4回)"
"エクセルが自己流なのできちんと勉強したいのですが？ - 基礎から実践まで充実した講座をご用意しています - **提供講座**： - Word Excel マスターコース（仕事に役立つ実践力を獲得） - エクセルビジネスデータ分析 - Excel VBA 講座 - Excel 統計分析 - レベルに合わせた各種講座"
"ワードとエクセルの勉強をしたいのですがどれくらいの費用と時間がかかります
か？ - **基本学習時間**： - ワード：16時間 - エクセル：16時間 - **MOS資格対策**：上記に加えさらに30時間 - **費用**：11,000 円(月謝月4回)" 
"なぜそんなに安いのですか？ - **理由**： - 20 年以上の歴史と経験と実績 - 独自の質の高いカリキュラムと技術 - テレビ宣伝を行わない - 人件費を抑制 - 教材は全て自社開発 - 高い利益率を追求していない"
"転職したいのでパソコンスキルと資格を取りたいのですが？ - **おすすめ**：パソコン入門コース - **学べる内容**： - タッチタイピング - パソコンの基本操作 - メールの基本 - インターネットの基礎 - ワード資格 - エクセル資格 - **さらなるキャリアアップに**： - エクセルピボットテーブル - エクセルパワークエリ - マイクロソフトパワープラットフォーム - エクセルビジネス統計 - 生成AI活用術"
"フォトショップやイラストレーターも勉強したいのですが？ - **提供講座**： - 初心者から始めるフォトショップコース - 初心者から始めるイラストレーターコース
- デザインスキルを基礎から学べます"
"ホームページを作りたいのですが全くパソコン初心者でも大丈夫でしょうか？ - はい、全くの初心者でも大丈夫です - 初心者向けのホームページ作成講座があります - 多くの方が初心者から始めて立派なホームページを完成させています - ホームページ制作事例をご覧いただけます"
"ネットショップを自分で運営したいのですがパソコン初心者でも大丈夫でしょう
か？ - はい、初心者でも大丈夫です - 段階的に学べるカリキュラムをご用意しています - 多くの方が初心者から独自のネットショップを立ち上げています - ネットショップ講座で基礎から学べます"
"大阪リボンスクールの概要を教えてください - **設立**：1998年に「ＲＢパソコンスクール」として創立（25年の実績） - **特徴**： - IT・AI・デザインを学べる総合スクール - 生成AIの活用講座やオンライン講座を提供 - 生成AI初心者向け勉強会を随時開催 - **公的支援**： - 2024 年度IT補助金支援事業者に採択 - 大阪府スキルアップ支援金対象 - 大阪市習い事・塾代助成事業対象 - 厚生労働省・教育訓練給付金講座提供"
"どのような講座が提供されていますか？ - **IT・AI スキル**： - 生成AI活用講座（オンライン） - 生成AI勉強会 - ChatGPT 等・RPA・PowerPlatform - **パソコン基本スキル**： - パソコン入門（タッチタイピング含む） - パソコンお困りごと相談 - パソコン自作講座"
"ビジネススキル**： - Word Excel マスターコース - Excel VBA - Excel 統計分析 - パソコン資格（MOS資格） - **クリエイティブスキル**： - ホームページ作成 - フォトショップ&イラストレーター - **子供向け**： - キッズプログラミングスクール"
"子供向けの講座はありますか？ - はい、**キッズプログラミングスクール**があります - **学べる内容**： - タッチタイピング - Scratch - VisualProgramming - HTML - JavaScript - Python - PremierePro - AfterEffects - **補助制度**：大阪市内在住の小学5年生～中学3年生は、大阪市習い事・塾代助成事業
の対象" 
"補助金を利用できる講座はありますか？ - はい、以下の公的支援制度が利用できる講座があります： - 大阪府スキルアップ支援金 - 大阪市習い事・塾代助成事業 - 厚生労働省・教育訓練給付金 - 経済産業省中小企業庁【2024年度・令和6年度】IT導入補助金 - 特に生成AI活用・ChatGPT等・RPA・PowerPlatformなどの講座はIT導入補助金が活
用可能 - 2024 年度IT補助金支援事業者に採択されています" 
"営業時間と休校日を教えてください 
- **営業時間**： - 水曜日～土曜日：午前10時～午後6時 - 日曜日：午前10時～午後5時 - **休校日**： - 毎週月曜日 - 毎週火曜日 - 祝祭日 - 詳細はカレンダーをご確認ください"
"授業時間割はどうなっていますか？ - **時間割**： - １時限目：10:00～10:50 - ２時限目：11:00～11:50 - 昼休み：12:00～13:00 - ３時限目：13:00～13:50 - ４時限目：14:00～14:50 - ５時限目：15:00～16:00 - ６時限目：16:00～16:50 - ７時限目：17:00～17:50 - 各時限は50分授業で、ご都合に合わせて受講可能"
"生成 AIについて学ぶことはできますか？ - はい、以下の講座があります： - 生成AI活用講座（オンライン） - 生成AI初心者向け勉強会（随時開催） - IT 導入補助金生成AI勉強会 - **学べる技術**： - 生成AI - ChatGPT - RPA（ロボティック・プロセス・オートメーション） - PowerPlatform - 個人商店・中小企業のお悩み解決にも役立ちます"
"コロナ対策はどうなっていますか？ - **実施している対策**： - 授業中のマスク着用 
- アルコール消毒液の設置 - 人との間隔を2ｍ確保 - 常時または適宜室内換気 - 空気清浄機（プラズマクラスター）の使用 - 受講生の安全を第一に考えた対応を行っています"
"リボンスクールの歴史を教えてください - **設立**：1998年に「ＲＢパソコンスクール」として創立 - **発展**： - 「英会話教室」「中国語教室」を開始し「リボンスクール」という別称を追加 - パソコン大好きな講師陣が立ち上げた小さなパソコン教室から始まる - 現在はIT、AI、デザイン、DXの新時代に対応した総合スクールへ成長 - **実績**：設立から25年の歴史と経験"
}

@app.route("/")
def hello():
    # デバッグ用（後で削除）
    token = os.environ.get('CHANNEL_ACCESS_TOKEN', 'Not Set')
    secret = os.environ.get('CHANNEL_SECRET', 'Not Set')
    return f"リボンスクールBotが稼働中です！<br>Token設定: {'OK' if len(token) > 100 else 'NG'} (長さ: {len(token)})<br>Secret設定: {'OK' if len(secret) > 20 else 'NG'}"

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_message = event.message.text
    reply_message = ""
    
    # 複数のキーワードをチェック
    found = False
    for keyword, answer in FAQ.items():
        if keyword in user_message:
            reply_message = answer
            found = True
            break
    
    if not found:
        # どの質問にも当てはまらない場合
        reply_message = """ご質問ありがとうございます😊

以下についてお答えできます：
📍 体験レッスン
📍 初心者の方へ
📍 持ち物
📍 料金
📍 予約方法
📍 場所・アクセス
📍 営業時間
📍 資格取得
📍 コース内容

知りたい内容をメッセージでお送りください。
お急ぎの場合は、お電話（06-6651-3832）でもお問い合わせいただけます。"""
    
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=reply_message)
    )

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
